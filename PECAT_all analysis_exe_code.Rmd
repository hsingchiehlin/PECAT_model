---
title: "PECAT_sensitivity analysis_exe_code"
author: "Hsing-Chieh Lin"
date: "2022/7/21"
output: html_document
---
# This script is for "Development of Physiological-based Gut Absorption Model to Improve Modeling of Bioavailability for Environmental Chemicals"

# Simulation setting:
# 1. Switches off intestine epithilia and kidney metabolite
# 2. f_reabs = 0; ETS = 0
# 3. simulate 10000 hr 
# 4. continuous exposure 75 mg = 312.8389 micromole
# 5. scenarios: SI + LI

```{Basic and Path setting}
# basic setting
if(!dir.exists("outputs")) dir.create("outputs")
if(!dir.exists("plots")) dir.create("plots")
library(tidyverse)
library(ggplot2)
library(ggridges)
library(scales)
library(ggpubr)
library(cowplot)
library(gridExtra)
library(grid)
library(Metrics)
library(EnvStats)
library(patchwork)
library(httk)
# Create mod.exe 
source("MCSim/function.R")
set_PATH()
makemod()
```


```{Site-specific permaebility ratio (using P_jejunum as dominator)}
# ---------- "Correlation" check ----------
# Load raw data of Site-specific Peff ratio
Peff.ratio <- read.csv("DATA/Site-specific Peff data.csv")
Peff.ratio.jej <- Peff.ratio[c("Chemical", "Duo.Jej.ratio", "Ile.Jej.ratio", "Col.Jej.ratio")]
Peff.ratio.jej$Col.Jej.ratio[3] <- NA #rm. outlier

# Customize upper panel
# Scatter Plot Matrices "pearson"
upper.panel<-function(x, y){
  points(x,y, pch=19, cex = 1.2, col=rgb(38, 102, 207, maxColorValue = 255, alpha = 200))
  r <- round(cor(x, y, use = "complete.obs"), digits=2)
  txt <- paste0("Pearson's R = ", r)
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  text(0.6, 0.1, txt, cex = 1.2)
}
# Figure S2A
pairs(log(Peff.ratio.jej[,2:4]), lower.panel = NULL, 
      upper.panel = upper.panel)


# ---------- "Distribution" check and statistical information ----------
Summary.Peff.ratio.data.jej <- as.data.frame(matrix(NA, 4, 6))
colnames(Summary.Peff.ratio.data.jej) <- c("Mean", "SD", "Geo.mean", "Geo.SD", "p_value.normal", "p_value.lognormal")
rownames(Summary.Peff.ratio.data.jej) <- c("Duo", "Ile", "Col", "Col.rm.out")

Summary.Peff.ratio.data.jej$Mean[1] <- mean(Peff.ratio.jej$Duo.Jej.ratio, na.rm = T)
Summary.Peff.ratio.data.jej$Mean[2] <- mean(Peff.ratio.jej$Ile.Jej.ratio, na.rm = T)
Summary.Peff.ratio.data.jej$Mean[3] <- mean(Peff.ratio.jej$Col.Jej.ratio, na.rm = T)

Summary.Peff.ratio.data.jej$SD[1] <- sd(Peff.ratio.jej$Duo.Jej.ratio, na.rm = T)
Summary.Peff.ratio.data.jej$SD[2] <- sd(Peff.ratio.jej$Ile.Jej.ratio, na.rm = T)
Summary.Peff.ratio.data.jej$SD[3] <- sd(Peff.ratio.jej$Col.Jej.ratio, na.rm = T)

Summary.Peff.ratio.data.jej$Geo.mean[1] <- exp(mean(log(Peff.ratio.jej$Duo.Jej.ratio), na.rm = T))
Summary.Peff.ratio.data.jej$Geo.mean[2] <- exp(mean(log(Peff.ratio.jej$Ile.Jej.ratio), na.rm = T))
Summary.Peff.ratio.data.jej$Geo.mean[3] <- exp(mean(log(Peff.ratio.jej$Col.Jej.ratio), na.rm = T))

Summary.Peff.ratio.data.jej$Geo.SD[1] <- geoSD(Peff.ratio.jej$Duo.Jej.ratio, na.rm = T)
Summary.Peff.ratio.data.jej$Geo.SD[2] <- geoSD(Peff.ratio.jej$Ile.Jej.ratio, na.rm = T)
Summary.Peff.ratio.data.jej$Geo.SD[3] <- geoSD(Peff.ratio.jej$Col.Jej.ratio, na.rm = T)

Summary.Peff.ratio.data.jej$log.mean[1] <- mean(log(Peff.ratio.jej$Duo.Jej.ratio), na.rm = T)
Summary.Peff.ratio.data.jej$log.mean[2] <- mean(log(Peff.ratio.jej$Ile.Jej.ratio), na.rm = T)
Summary.Peff.ratio.data.jej$log.mean[3] <- mean(log(Peff.ratio.jej$Col.Jej.ratio), na.rm = T)

Summary.Peff.ratio.data.jej$log.SD[1] <- sd(log(Peff.ratio.jej$Duo.Jej.ratio), na.rm = T)
Summary.Peff.ratio.data.jej$log.SD[2] <- sd(log(Peff.ratio.jej$Ile.Jej.ratio), na.rm = T)
Summary.Peff.ratio.data.jej$log.SD[3] <- sd(log(Peff.ratio.jej$Col.Jej.ratio), na.rm = T)

Summary.Peff.ratio.data.jej$p_value.normal[1] <- shapiro.test(Peff.ratio.jej$Duo.Jej.ratio)$p.value # p-value = 0.7459 -> normality
Summary.Peff.ratio.data.jej$p_value.normal[2] <- shapiro.test(Peff.ratio.jej$Ile.Jej.ratio)$p.value # p-value = 0.02459 -> no normality
Summary.Peff.ratio.data.jej$p_value.normal[3] <- shapiro.test(Peff.ratio.jej$Col.Jej.ratio)$p.value # p-value = 2.41e-05 -> no normality

Summary.Peff.ratio.data.jej$p_value.lognormal[1] <- shapiro.test(log(Peff.ratio.jej$Duo.Jej.ratio))$p.value # p-value = 0.4757 -> normality
Summary.Peff.ratio.data.jej$p_value.lognormal[2] <- shapiro.test(log(Peff.ratio.jej$Ile.Jej.ratio))$p.value # p-value = 0.4693 -> normality
Summary.Peff.ratio.data.jej$p_value.lognormal[3] <- shapiro.test(log(Peff.ratio.jej$Col.Jej.ratio))$p.value # p-value = 0.000163-> no normality

# p-value > 0.05 implying that the distribution of the data are not significantly different from normal distribution. 
# In other words, we can assume the normality.

write.csv(Summary.Peff.ratio.data.jej, "outputs/Summary.Peff.ratio.data.jej.csv")


# compile data for plotting
Summary.Peff.ratio.data.jej <- read.csv("outputs/Summary.Peff.ratio.data.jej.csv")
Summary.Peff.ratio.data.jej$Site <- c("Duodenum", "Ileum", "Colon")

Peff.ratio.plot.jej <- Peff.ratio.jej[-1]

Peff.site.plot.raw.data.jej <- data.frame(Site = rep(c("Duodenum", "Ileum", "Colon"), each = 55))
Peff.site.plot.raw.data.jej$Peff.ratio <- unlist(Peff.ratio.plot.jej)
Peff.site.plot.raw.data.jej$log.Peff.ratio <- log(Peff.site.plot.raw.data.jej$Peff.ratio)

```


```{Site-specific permaebility ratio (using P_colon as dominator)}
# ---------- "Correlation" check ----------
# Load raw data of Site-specific Peff ratio
Peff.ratio <- read.csv("DATA/Site-specific Peff data.csv")

Peff.ratio$Duo.colon.ratio <- Peff.ratio$Duo.P/Peff.ratio$Col.P
Peff.ratio$Jej.colon.ratio <- Peff.ratio$Jej.P/Peff.ratio$Col.P
Peff.ratio$Ile.colon.ratio <- Peff.ratio$Ile.P/Peff.ratio$Col.P

Peff.ratio.col <- Peff.ratio[c("Chemical", "Duo.colon.ratio", "Jej.colon.ratio", "Ile.colon.ratio")]

# Customize upper panel
# Scatter Plot Matrices "pearson"
upper.panel<-function(x, y){
  points(x,y, pch=19, cex = 1.2, col=rgb(255, 77, 77, maxColorValue = 255, alpha = 200))
  r <- round(cor(x, y, use = "complete.obs"), digits=2)
  txt <- paste0("Pearson's R = ", r)
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  text(0.6, 0.1, txt, cex = 1.2)
}
pairs(log(Peff.ratio.col[,2:4]), lower.panel = NULL, 
      upper.panel = upper.panel)

# remove cyclosporin data
Peff.ratio.col <- Peff.ratio.col[-3, ]

# Figure S2B
# Scatter Plot Matrices "pearson" (remove cyclosporin data)
pairs(log(Peff.ratio.col[,2:4]), lower.panel = NULL, 
      upper.panel = upper.panel)


# ---------- "Distribution" check and statistical information ----------
Summary.Peff.ratio.data.col <- as.data.frame(matrix(NA, 3, 6))
colnames(Summary.Peff.ratio.data.col) <- c("Mean", "SD", "Geo.mean", "Geo.SD", "p_value.normal", "p_value.lognormal")
rownames(Summary.Peff.ratio.data.col) <- c("Duo.rm.out", "Jej.rm.out", "Ile.rm.out")

Summary.Peff.ratio.data.col$Mean[1] <- mean(Peff.ratio.col$Duo.colon.ratio, na.rm = T)
Summary.Peff.ratio.data.col$Mean[2] <- mean(Peff.ratio.col$Jej.colon.ratio, na.rm = T)
Summary.Peff.ratio.data.col$Mean[3] <- mean(Peff.ratio.col$Ile.colon.ratio, na.rm = T)

Summary.Peff.ratio.data.col$SD[1] <- sd(Peff.ratio.col$Duo.colon.ratio, na.rm = T)
Summary.Peff.ratio.data.col$SD[2] <- sd(Peff.ratio.col$Jej.colon.ratio, na.rm = T)
Summary.Peff.ratio.data.col$SD[3] <- sd(Peff.ratio.col$Ile.colon.ratio, na.rm = T)

Summary.Peff.ratio.data.col$Geo.mean[1] <- exp(mean(log(Peff.ratio.col$Duo.colon.ratio), na.rm = T))
Summary.Peff.ratio.data.col$Geo.mean[2] <- exp(mean(log(Peff.ratio.col$Jej.colon.ratio), na.rm = T))
Summary.Peff.ratio.data.col$Geo.mean[3] <- exp(mean(log(Peff.ratio.col$Ile.colon.ratio), na.rm = T))

Summary.Peff.ratio.data.col$Geo.SD[1] <- geoSD(Peff.ratio.col$Duo.colon.ratio, na.rm = T)
Summary.Peff.ratio.data.col$Geo.SD[2] <- geoSD(Peff.ratio.col$Jej.colon.ratio, na.rm = T)
Summary.Peff.ratio.data.col$Geo.SD[3] <- geoSD(Peff.ratio.col$Ile.colon.ratio, na.rm = T)

Summary.Peff.ratio.data.col$log.mean[1] <- mean(log(Peff.ratio.col$Duo.colon.ratio), na.rm = T)
Summary.Peff.ratio.data.col$log.mean[2] <- mean(log(Peff.ratio.col$Jej.colon.ratio), na.rm = T)
Summary.Peff.ratio.data.col$log.mean[3] <- mean(log(Peff.ratio.col$Ile.colon.ratio), na.rm = T)

Summary.Peff.ratio.data.col$log.SD[1] <- sd(log(Peff.ratio.col$Duo.colon.ratio), na.rm = T)
Summary.Peff.ratio.data.col$log.SD[2] <- sd(log(Peff.ratio.col$Jej.colon.ratio), na.rm = T)
Summary.Peff.ratio.data.col$log.SD[3] <- sd(log(Peff.ratio.col$Ile.colon.ratio), na.rm = T)

Summary.Peff.ratio.data.col$p_value.normal[1] <- shapiro.test(Peff.ratio.col$Duo.colon.ratio)$p.value 
Summary.Peff.ratio.data.col$p_value.normal[2] <- shapiro.test(Peff.ratio.col$Jej.colon.ratio)$p.value 
Summary.Peff.ratio.data.col$p_value.normal[3] <- shapiro.test(Peff.ratio.col$Ile.colon.ratio)$p.value

Summary.Peff.ratio.data.col$p_value.lognormal[1] <- shapiro.test(log(Peff.ratio.col$Duo.colon.ratio))$p.value 
Summary.Peff.ratio.data.col$p_value.lognormal[2] <- shapiro.test(log(Peff.ratio.col$Jej.colon.ratio))$p.value 
Summary.Peff.ratio.data.col$p_value.lognormal[3] <- shapiro.test(log(Peff.ratio.col$Ile.colon.ratio))$p.value 

Summary.Peff.ratio.data.col$Min[1] <- min(Peff.ratio.col$Duo.colon.ratio, na.rm = T) 
Summary.Peff.ratio.data.col$Min[2] <- min(Peff.ratio.col$Jej.colon.ratio, na.rm = T) 
Summary.Peff.ratio.data.col$Min[3] <- min(Peff.ratio.col$Ile.colon.ratio, na.rm = T)

Summary.Peff.ratio.data.col$Max[1] <- max(Peff.ratio.col$Duo.colon.ratio, na.rm = T)
Summary.Peff.ratio.data.col$Max[2] <- max(Peff.ratio.col$Jej.colon.ratio, na.rm = T)
Summary.Peff.ratio.data.col$Max[3] <- max(Peff.ratio.col$Ile.colon.ratio, na.rm = T)

# p-value > 0.05 implying that the distribution of the data are not significantly different from normal distribution. 
# In other words, we can assume the normality.

write.csv(Summary.Peff.ratio.data.col, "outputs/Summary.Peff.ratio.data.col.csv")


# compile data for plotting
Summary.Peff.ratio.data.col <- read.csv("outputs/Summary.Peff.ratio.data.col.csv")
Summary.Peff.ratio.data.col <- Summary.Peff.ratio.data.col[-c(1:3), ]
Summary.Peff.ratio.data.col$Site <- c("Duodenum", "Jejunum", "Ileum")

Peff.ratio.plot.col <- Peff.ratio.col[-1]
Peff.site.plot.raw.data.col <- data.frame(Site = rep(c("Duodenum", "Jejunum", "Ileum"), each = 54)) # for include all data
Peff.site.plot.raw.data.col$Peff.ratio <- unlist(Peff.ratio.plot.col)
Peff.site.plot.raw.data.col$log.Peff.ratio <- log(Peff.site.plot.raw.data.col$Peff.ratio)


# ---------- Site-specific Peff (colon) ratio : multivariate normal distribution ----------
# After check the Pearson's correlation coefficient, the colon ratios have high correlation,
# therefore, need to use multivariate normal distribution to randomly create the parameters with original correlation and used in following MC simulation

r2_duo_jej <- 0.80
r2_duo_ile <- 0.68
r2_jej_ile <- 0.82

Log.SD <- Summary.Peff.ratio.data.col$log.SD # order: DUo Jej Ile

# covariance matrix 
#    DUo Jej Ile
# DUo
# Jej
# Ile
cov_matrix <- matrix(c(Log.SD[1]^2, r2_duo_jej*Log.SD[1]*Log.SD[2], r2_duo_ile*Log.SD[1]*Log.SD[3],
                       r2_duo_jej*Log.SD[1]*Log.SD[2], Log.SD[2]^2, r2_jej_ile*Log.SD[2]*Log.SD[3],
                       r2_duo_ile*Log.SD[1]*Log.SD[3], r2_jej_ile*Log.SD[2]*Log.SD[3], Log.SD[3]^2),3,3)

library(MASS)
mean.peff.colon <- Summary.Peff.ratio.data$log.mean # order: DUo Jej Ile
multi.nor.colpara <- mvrnorm(n = 10000, mean.peff.colon, cov_matrix)
multi.nor.colpara <- as.data.frame(multi.nor.colpara)
colnames(multi.nor.colpara) <- c("Duo.colon.ratio", "Jej.colon.ratio", "Ile.colon.ratio")
#check randomly-generated parameters have similar correlation with raw data
upper.panel<-function(x, y){
  points(x,y, pch=19, cex = 1.2, col=rgb(255, 77, 77, maxColorValue = 255, alpha = 200))
  r <- round(cor(x, y, use = "complete.obs"), digits=2)
  txt <- paste0("Pearson's R = ", r)
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  text(0.6, 0.1, txt, cex = 1.2)
}
pairs(multi.nor.colpara, lower.panel = NULL, 
      upper.panel = upper.panel)

multi.nor.colpara.exp <- exp(multi.nor.colpara)
write.csv(multi.nor.colpara.exp, "multi.nor.colpara.exp.csv")
write.csv(multi.nor.colpara, "multi.nor.colpara.csv")

```


```{Plotting Figure 3_segment-sepecific permeability ratio}
# Log transformed plotting (rm outlier_jeju ratio)
p3.1 <- ggplot() +
  geom_violin(aes(Peff.site.plot.raw.data.jej$Site, Peff.site.plot.raw.data.jej$log.Peff.ratio, fill = Peff.site.plot.raw.data.jej$Site), linetype = "blank", trim = F)+
  scale_fill_manual(values=c("Duodenum" = "#4BA1EF25", "Ileum" = "#4EBDAE25", "Colon" = "#ffa72b25"))+
  
  geom_jitter(aes(Peff.site.plot.raw.data.jej$Site, Peff.site.plot.raw.data.jej$log.Peff.ratio), 
              position = position_jitter(0.2), color = "gray") + 
  annotate("text", x=0.5, y=2.5, label="A", hjust=0, fontface = "bold", size=5) +
  geom_pointrange(aes(x = Site, y = log.mean, ymin = log.mean-log.SD, ymax = log.mean+log.SD, color = Site), data = Summary.Peff.ratio.data.jej, size=1, fatten = 2.5)+
  scale_colour_manual(values = c("Duodenum" = "#4BA1EF", "Ileum" = "#4EBDAE", "Colon" = "#ffa72b")) +
  scale_x_discrete(limits = c("Duodenum", "Ileum", "Colon")) +
  
  theme_light() +
  labs(y = expression(paste("Log(P"[i]," / ", "P"[Jejunum], ")")), x= "") +
  theme(legend.position = "none",
        panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "lightgray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black", size = 0.8),
        axis.title = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        axis.text.x = element_text(color = "black"),
        strip.text = element_text(color = "black"))

# Log transformed plotting (rm outlier_colon ratio)
p3.2 <- ggplot() +
  geom_violin(aes(Peff.site.plot.raw.data.col$Site, Peff.site.plot.raw.data.col$log.Peff.ratio, fill = Peff.site.plot.raw.data.col$Site), linetype = "blank", trim = F)+
  scale_fill_manual(values=c("Duodenum" = "#4BA1EF25", "Jejunum" = "#FF836425", "Ileum" = "#4EBDAE25"))+
  
  geom_jitter(aes(Peff.site.plot.raw.data.col$Site, Peff.site.plot.raw.data.col$log.Peff.ratio), 
              position = position_jitter(0.2), color = "gray") + 
  annotate("text", x=0.5, y=6.015, label="B", hjust=0, fontface = "bold", size=5) +
  geom_pointrange(aes(x = Site, y = log.mean, ymin = log.mean-log.SD, ymax = log.mean+log.SD, color = Site), data = Summary.Peff.ratio.data.col, size=1, fatten = 2.5)+
  scale_colour_manual(values = c("Duodenum" = "#4BA1EF", "Jejunum" = "#FF8364", "Ileum" = "#4EBDAE")) +
  scale_x_discrete(limits = c("Duodenum", "Jejunum", "Ileum")) +
  
  theme_light() +
  labs(y = expression(paste("Log(P"[i]," / ", "P"[Colon], ")")), x= "Site") +
  theme(legend.position = "none",
        panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "lightgray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black", size = 0.8),
        axis.title = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        axis.text.x = element_text(color = "black"),
        strip.text = element_text(color = "black"))

tiff(width = 5.4, height = 6, "plots/Figure 3_segment-sepecific permeability ratio.tiff", units = "in", res=600)
p3.1 + p3.2 + plot_layout(height = c(1, 1))
dev.off()

```


```{IVIVE ratio and Plotting Figure 4_IVIVE ratio}
IVIVE_ratio <- read.csv("DATA/ivive_ratio_new.csv")

Summary.IVIVE.ratio <- as.data.frame(matrix(NA, 1, 8))
colnames(Summary.IVIVE.ratio) <- c("Mean", "SD", "log.mean","log.SD", "Geo.mean", "Geo.SD", "p_value.normal", "p_value.lognormal")

Summary.IVIVE.ratio$Mean <- mean(IVIVE_ratio$ivive_ratio, na.rm = T)
Summary.IVIVE.ratio$SD <- sd(IVIVE_ratio$ivive_ratio, na.rm = T)
Summary.IVIVE.ratio$log.mean <- mean(log(IVIVE_ratio$ivive_ratio), na.rm = T)
Summary.IVIVE.ratio$log.SD <- sd(log(IVIVE_ratio$ivive_ratio), na.rm = T)
Summary.IVIVE.ratio$Geo.mean <- exp(mean(log(IVIVE_ratio$ivive_ratio), na.rm = T))
Summary.IVIVE.ratio$Geo.SD <- geoSD(IVIVE_ratio$ivive_ratio, na.rm = T)
Summary.IVIVE.ratio$p_value.normal <- shapiro.test(IVIVE_ratio$ivive_ratio)$p.value
Summary.IVIVE.ratio$p_value.lognormal <- shapiro.test(log(IVIVE_ratio$ivive_ratio))$p.value

IVIVE_ratio$log.ratio <- log(IVIVE_ratio$ivive_ratio)

tiff(width = 5, height = 4, "plots/Figure.4_IVIVE ratio.tiff", units = "in", res=600)
ggplot(IVIVE_ratio, aes(x=log.ratio)) + 
  geom_histogram(aes(y=..density..), colour="#2747D3", fill="white")+
  geom_density(alpha=.2, fill="#2772D3", colour="#2772D3", size = 0.6)+
  geom_vline(aes(xintercept=mean(log.ratio, na.rm = T)),
             color="#EA5038", linetype="dashed", size=0.7)+
  labs(x=expression(paste("log (P"[app], "/P"[eff], ")")), y = "Density")+
  ylim(0, 0.4)+
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black"),
        axis.text = element_text(color = "black"))
dev.off()
```


```{PECAT model - senesitivity analysis and Plotting figure}
# ---------- Model construction ----------
model <- "enviro_chem_CAT_PBPK_newvol_withratio.model.R"
makemcsim(model)

# ----------  check the effect of chemical-specific parameter on %abs ---------- 
mc_sim_results_check.para <- matrix(NA, length(Peff_cm_s), 11)
mc_sim_results_check.para[, 10] <- Peff_dm_h
mc_sim_results_check.para[, 11] <- Peff_cm_s
colnames(mc_sim_results_check.para) <- c("C_blood_med", "C_blood_LCL", "C_blood_UCL",
                                         "Css_med", "Css_LCL", "Css_UCL",
                                         "abs_med", "abs_LCL", "abs_UCL",
                                         "Peff_dm_h", "Peff_cm_s")
rownames(mc_sim_results_check.para) <- in.file
mc_sim_results_check.para <- as.data.frame(mc_sim_results_check.para)

# mc simulation for check.para ("In files/check the effect of che-specific para. on %abs")
for (i in in.file){
  
  from.path <- paste("MCsim/In files/check the effect of che-specific para. on %abs/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  mc_sim_results_check.para[i, c(1:3)] <- mc.sim[(101*1), ] # put C_blood into the "mc_sim_results_check.para"
  mc_sim_results_check.para[i, c(4:6)] <- mc.sim[(101*2), ] # put Css into the "mc_sim_results_check.para"
  mc_sim_results_check.para[i, c(7:9)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results_check.para"
  
  print(i)
  
}
write.csv(mc_sim_results_check.para, "outputs/mc_sim_results_SI+LI_checking effect of che-specific para_on %abs.csv")
# Baseline simulation
# In order to compare the difference of sim results, the following code is used to create the baseline for only switch on the absorption of SL and LI.
# Using "In files/baseline sim (SI+LI)"
in.file.forbasic <- c("enviro_chem_abs_1.in.R", "enviro_chem_abs_2.in.R", "enviro_chem_abs_3.in.R", 
                      "enviro_chem_abs_4.in.R", "enviro_chem_abs_5.in.R", "enviro_chem_abs_6.in.R", 
                      "enviro_chem_abs_7.in.R", "enviro_chem_abs_8.in.R", "enviro_chem_abs_9.in.R", 
                      "enviro_chem_abs_10.in.R", "enviro_chem_abs_11.in.R", "enviro_chem_abs_12.in.R",
                      "enviro_chem_abs_13.in.R", "enviro_chem_abs_14.in.R", "enviro_chem_abs_15.in.R", 
                      "enviro_chem_abs_16.in.R", "enviro_chem_abs_17.in.R", "enviro_chem_abs_18.in.R", 
                      "enviro_chem_abs_19.in.R", "enviro_chem_abs_20.in.R", "enviro_chem_abs_21.in.R",
                      "enviro_chem_abs_22.in.R", "enviro_chem_abs_23.in.R", "enviro_chem_abs_24.in.R",
                      "enviro_chem_abs_25.in.R")
basic_sim_results <- matrix(NA, length(Peff_cm_s), 3)
basic_sim_results[, 2] <- Peff_dm_h
basic_sim_results[, 3] <- Peff_cm_s
colnames(basic_sim_results) <- c("abs", "Peff_dm_h", "Peff_cm_s")
rownames(basic_sim_results) <- in.file.forbasic
basic_sim_results <- as.data.frame(basic_sim_results)

for (i in in.file.forbasic){
  
  from.path <- paste("MCsim/In files/baseline sim (SI+LI)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  basic_sim_results[i, 1] <- out[101, 2]
  
  print(i)
  
}

#Plotting
tiff(width = 6, height = 3.2, "plots/Figure.S_sensitivity analysis_chemical-sepecific para. for Fabs.tiff", units = "in", res=600)
ggplot() + 
  # Baseline
  geom_line(aes(x=basic_sim_results$Peff_cm_s, y=basic_sim_results$abs), linetype = "solid", color="#3d424a", size = 2.5) + 
  # add dist. of chemical-sepecific para. for sensitivity analysis
  geom_line(aes(x=mc_sim_results_check.para$Peff_cm_s, y=mc_sim_results_check.para$abs_med), linetype = "dashed", color="#F05454", size = 1) + 
  geom_ribbon(aes(x=mc_sim_results_check.para$Peff_cm_s, ymin = mc_sim_results_check.para$abs_LCL, ymax = mc_sim_results_check.para$abs_UCL), fill = "#F0545420") +
  
  scale_x_log10(lim = c(1E-8,1E-2),
                breaks = trans_breaks("log10", function(x) 10^x, n = 6),
                labels = trans_format("log10", math_format(10^.x))) +
  
  xlab("Permeability (cm/s)") + ylab("% of absorption")+
  
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", size = 1.1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black", face = "bold"),
        axis.text = element_text(color = "black", face = "bold"))
dev.off()
```


```{PECAT model - MC simulation}
# ---------- Model construction ----------
model <- "enviro_chem_CAT_PBPK_newvol_withratio.model.R"
makemcsim(model)

# ---------- Create results data sheet ----------
in.file <- c("enviro_chem_mc_1.in.R", "enviro_chem_mc_2.in.R", "enviro_chem_mc_3.in.R", 
             "enviro_chem_mc_4.in.R", "enviro_chem_mc_5.in.R", "enviro_chem_mc_6.in.R", 
             "enviro_chem_mc_7.in.R", "enviro_chem_mc_8.in.R", "enviro_chem_mc_9.in.R", 
             "enviro_chem_mc_10.in.R", "enviro_chem_mc_11.in.R", "enviro_chem_mc_12.in.R",
             "enviro_chem_mc_13.in.R", "enviro_chem_mc_14.in.R", "enviro_chem_mc_15.in.R", 
             "enviro_chem_mc_16.in.R", "enviro_chem_mc_17.in.R", "enviro_chem_mc_18.in.R", 
             "enviro_chem_mc_19.in.R", "enviro_chem_mc_20.in.R", "enviro_chem_mc_21.in.R",
             "enviro_chem_mc_22.in.R", "enviro_chem_mc_23.in.R", "enviro_chem_mc_24.in.R",
             "enviro_chem_mc_25.in.R")

Peff_dm_h <- (10^seq(-8, -2, 0.25))*360 # unit: dm/h (used in model)
Peff_cm_s <- 10^seq(-8, -2, 0.25) # # unit: cm/s (used to plot)

# mc simulated results file
# "jeju" as dominant 
mc_sim_results_jeju <- matrix(NA, length(Peff_cm_s), 11)
mc_sim_results_jeju[, 10] <- Peff_dm_h
mc_sim_results_jeju[, 11] <- Peff_cm_s
colnames(mc_sim_results_jeju) <- c("C_blood_med", "C_blood_LCL", "C_blood_UCL",
                                  "Css_med", "Css_LCL", "Css_UCL",
                                  "abs_med", "abs_LCL", "abs_UCL",
                                  "Peff_dm_h", "Peff_cm_s")
rownames(mc_sim_results_jeju) <- in.file
mc_sim_results_jeju <- as.data.frame(mc_sim_results_jeju)

# "colon" as dominant 
mc_sim_results_colon <- matrix(NA, length(Peff_cm_s), 11)
mc_sim_results_colon[, 10] <- Peff_dm_h
mc_sim_results_colon[, 11] <- Peff_cm_s
colnames(mc_sim_results_colon) <- c("C_blood_med", "C_blood_LCL", "C_blood_UCL",
                                   "Css_med", "Css_LCL", "Css_UCL",
                                   "abs_med", "abs_LCL", "abs_UCL",
                                   "Peff_dm_h", "Peff_cm_s")
rownames(mc_sim_results_colon) <- in.file
mc_sim_results_colon <- as.data.frame(mc_sim_results_colon)

# "jeju" as dominant with IVIVE
mc_sim_results_jeju_ivive <- matrix(NA, length(Peff_cm_s), 11)
mc_sim_results_jeju_ivive[, 10] <- Peff_dm_h
mc_sim_results_jeju_ivive[, 11] <- Peff_cm_s
colnames(mc_sim_results_jeju_ivive) <- c("C_blood_med", "C_blood_LCL", "C_blood_UCL",
                                   "Css_med", "Css_LCL", "Css_UCL",
                                   "abs_med", "abs_LCL", "abs_UCL",
                                   "Peff_dm_h", "Peff_cm_s")
rownames(mc_sim_results_jeju_ivive) <- in.file
mc_sim_results_jeju_ivive <- as.data.frame(mc_sim_results_jeju_ivive)


# ---------- MC simulation ----------
# simulation using jeju ratio
# in.file: Relationship curve (using ratio Peff_juje as denominator)
for (i in in.file){
  
  from.path <- paste("MCsim/In files/Relationship curve (using ratio Peff_juje as denominator)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  mc_sim_results_jeju[i, c(1:3)] <- mc.sim[(101*1), ] # put C_blood into the "mc_sim_results"
  mc_sim_results_jeju[i, c(4:6)] <- mc.sim[(101*2), ] # put Css into the "mc_sim_results"
  mc_sim_results_jeju[i, c(7:9)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
}

# simulation using colon ratio
# in.file: Relationship curve (using ratio Peff_colon as denominator) - setpt
# create setpoint file
X <- read.csv("multi.nor.colpara.exp.csv")
write.table(X, file = "setpts.out", row.names = F, sep = "\t")

for (i in in.file){
  
  from.path <- paste("MCsim/In files/Relationship curve (using ratio Peff_colon as denominator) - setpt/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  mc_sim_results_colon[i, c(1:3)] <- mc.sim[(101*1), ] # put C_blood into the "mc_sim_results"
  mc_sim_results_colon[i, c(4:6)] <- mc.sim[(101*2), ] # put Css into the "mc_sim_results"
  mc_sim_results_colon[i, c(7:9)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
}

# simulation using jeju ratio and ivive ratio
# in.file: Relationship curve (using ratio Peff_juje as denominator with new IVIVE.R)
for (i in in.file){
  
  from.path <- paste("MCsim/In files/Relationship curve (using ratio Peff_juje as denominator with new IVIVE.R)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  mc_sim_results_jeju_ivive[i, c(1:3)] <- mc.sim[(101*1), ] # put C_blood into the "mc_sim_results"
  mc_sim_results_jeju_ivive[i, c(4:6)] <- mc.sim[(101*2), ] # put Css into the "mc_sim_results"
  mc_sim_results_jeju_ivive[i, c(7:9)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
}

write.csv(mc_sim_results_jeju, "outputs/rela_p_abs_SI+LI_jeju as base.csv")
write.csv(mc_sim_results_colon, "outputs/rela_p_abs_SI+LI_colon as base_cov.csv")
write.csv(mc_sim_results_jeju_ivive, "outputs/rela_p_abs_SI+LI_newivive_jeju as base.csv")


# ---------- Plotting: Figure.S1_css_check ----------
# Check Css equation workable
css_check_data <- rbind(mc_sim_results_jeju[, c(1,4)], mc_sim_results_colon[, c(1,4)])
css_check_data$ratio <- rep(c("A. Ratio_jeju", "B. Ratio_colon"), each = 25)

ggplot(css_check_data)+
  geom_point(aes(x=C_blood_med, y=Css_med, colour=ratio), alpha=0.6, size=3, shape=16) +
  geom_abline(intercept = 0, slope = 1, linetype=2)+
  
  facet_wrap(~ ratio) +
  
  scale_x_log10(lim = c(1E-5, 2),
                breaks = trans_breaks("log10", function(x) 10^x, n = 6),
                labels = trans_format("log10", math_format(10^.x))) +
  
  scale_y_log10(lim = c(1E-5, 2),
                breaks = trans_breaks("log10", function(x) 10^x, n = 6),
                labels = trans_format("log10", math_format(10^.x))) +
  
  theme_bw() + 
  xlab("Css from PBPK (microM)") +
  ylab("Css from equation (microM)")+
  theme(text=element_text(family="sans", face="plain", color="#000000", size=10, hjust=0.5, vjust=0.5), 
        legend.position = "none",
        #panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black", face = "bold"),
        axis.text = element_text(color = "black", face = "bold"),
        strip.text.x = element_text(size=11, face = "bold"))

ggsave("plots/Figure.S1_css_check.tiff", height = 3.5, width = 7.5, units="in")



# ---------- Predict Fabs for comparing with observed data ----------
in.file <- c("enviro_chem_mc_1.in.R", "enviro_chem_mc_2.in.R", "enviro_chem_mc_3.in.R", "enviro_chem_mc_4.in.R", "enviro_chem_mc_5.in.R", 
             "enviro_chem_mc_6.in.R", "enviro_chem_mc_7.in.R", "enviro_chem_mc_8.in.R", "enviro_chem_mc_9.in.R", "enviro_chem_mc_10.in.R",
             "enviro_chem_mc_11.in.R", "enviro_chem_mc_12.in.R", "enviro_chem_mc_13.in.R", "enviro_chem_mc_14.in.R", "enviro_chem_mc_15.in.R", 
             "enviro_chem_mc_16.in.R", "enviro_chem_mc_17.in.R", "enviro_chem_mc_18.in.R", "enviro_chem_mc_19.in.R", "enviro_chem_mc_20.in.R",
             "enviro_chem_mc_21.in.R", "enviro_chem_mc_22.in.R", "enviro_chem_mc_23.in.R", "enviro_chem_mc_24.in.R", "enviro_chem_mc_25.in.R", 
             "enviro_chem_mc_26.in.R", "enviro_chem_mc_27.in.R", "enviro_chem_mc_28.in.R", "enviro_chem_mc_29.in.R", "enviro_chem_mc_30.in.R",
             "enviro_chem_mc_31.in.R", "enviro_chem_mc_32.in.R", "enviro_chem_mc_33.in.R", "enviro_chem_mc_34.in.R", "enviro_chem_mc_35.in.R", 
             "enviro_chem_mc_36.in.R", "enviro_chem_mc_37.in.R", "enviro_chem_mc_38.in.R", "enviro_chem_mc_39.in.R", "enviro_chem_mc_40.in.R", 
             "enviro_chem_mc_41.in.R", "enviro_chem_mc_42.in.R", "enviro_chem_mc_43.in.R", "enviro_chem_mc_44.in.R", "enviro_chem_mc_45.in.R",
             "enviro_chem_mc_46.in.R", "enviro_chem_mc_47.in.R", "enviro_chem_mc_48.in.R", "enviro_chem_mc_49.in.R", "enviro_chem_mc_50.in.R", 
             "enviro_chem_mc_51.in.R", "enviro_chem_mc_52.in.R", "enviro_chem_mc_53.in.R", "enviro_chem_mc_54.in.R", "enviro_chem_mc_55.in.R", 
             "enviro_chem_mc_56.in.R", "enviro_chem_mc_57.in.R", "enviro_chem_mc_58.in.R", "enviro_chem_mc_59.in.R", "enviro_chem_mc_60.in.R",
             "enviro_chem_mc_61.in.R", "enviro_chem_mc_62.in.R", "enviro_chem_mc_63.in.R", "enviro_chem_mc_64.in.R", "enviro_chem_mc_65.in.R",
             "enviro_chem_mc_66.in.R", "enviro_chem_mc_67.in.R", "enviro_chem_mc_68.in.R", "enviro_chem_mc_69.in.R", "enviro_chem_mc_70.in.R",
             "enviro_chem_mc_71.in.R", "enviro_chem_mc_72.in.R", "enviro_chem_mc_73.in.R", "enviro_chem_mc_74.in.R", "enviro_chem_mc_75.in.R",
             "enviro_chem_mc_76.in.R", "enviro_chem_mc_77.in.R", "enviro_chem_mc_78.in.R", "enviro_chem_mc_79.in.R", "enviro_chem_mc_80.in.R",
             "enviro_chem_mc_81.in.R", "enviro_chem_mc_82.in.R", "enviro_chem_mc_83.in.R", "enviro_chem_mc_84.in.R", "enviro_chem_mc_85.in.R", 
             "enviro_chem_mc_86.in.R", "enviro_chem_mc_87.in.R", "enviro_chem_mc_88.in.R", "enviro_chem_mc_89.in.R", "enviro_chem_mc_90.in.R",
             "enviro_chem_mc_91.in.R", "enviro_chem_mc_92.in.R", "enviro_chem_mc_93.in.R", "enviro_chem_mc_94.in.R", "enviro_chem_mc_95.in.R", 
             "enviro_chem_mc_96.in.R", "enviro_chem_mc_97.in.R", "enviro_chem_mc_98.in.R", "enviro_chem_mc_99.in.R", "enviro_chem_mc_100.in.R",
             "enviro_chem_mc_101.in.R", "enviro_chem_mc_102.in.R", "enviro_chem_mc_103.in.R", "enviro_chem_mc_104.in.R", "enviro_chem_mc_105.in.R", 
             "enviro_chem_mc_106.in.R", "enviro_chem_mc_107.in.R", "enviro_chem_mc_108.in.R", "enviro_chem_mc_109.in.R", "enviro_chem_mc_110.in.R",
             "enviro_chem_mc_111.in.R", "enviro_chem_mc_112.in.R", "enviro_chem_mc_113.in.R", "enviro_chem_mc_114.in.R", "enviro_chem_mc_115.in.R", 
             "enviro_chem_mc_116.in.R", "enviro_chem_mc_117.in.R", "enviro_chem_mc_118.in.R", "enviro_chem_mc_119.in.R", "enviro_chem_mc_120.in.R",
             "enviro_chem_mc_121.in.R", "enviro_chem_mc_122.in.R", "enviro_chem_mc_123.in.R", "enviro_chem_mc_124.in.R", "enviro_chem_mc_125.in.R", 
             "enviro_chem_mc_126.in.R", "enviro_chem_mc_127.in.R", "enviro_chem_mc_128.in.R", "enviro_chem_mc_129.in.R", "enviro_chem_mc_130.in.R",
             "enviro_chem_mc_131.in.R", "enviro_chem_mc_132.in.R", "enviro_chem_mc_133.in.R", "enviro_chem_mc_134.in.R", "enviro_chem_mc_135.in.R", 
             "enviro_chem_mc_136.in.R", "enviro_chem_mc_137.in.R", "enviro_chem_mc_138.in.R", "enviro_chem_mc_139.in.R", "enviro_chem_mc_140.in.R", 
             "enviro_chem_mc_141.in.R", "enviro_chem_mc_142.in.R", "enviro_chem_mc_143.in.R", "enviro_chem_mc_144.in.R", "enviro_chem_mc_145.in.R",
             "enviro_chem_mc_146.in.R", "enviro_chem_mc_147.in.R", "enviro_chem_mc_148.in.R", "enviro_chem_mc_149.in.R", "enviro_chem_mc_150.in.R", 
             "enviro_chem_mc_151.in.R", "enviro_chem_mc_152.in.R", "enviro_chem_mc_153.in.R", "enviro_chem_mc_154.in.R", "enviro_chem_mc_155.in.R", 
             "enviro_chem_mc_156.in.R", "enviro_chem_mc_157.in.R", "enviro_chem_mc_158.in.R", "enviro_chem_mc_159.in.R", "enviro_chem_mc_160.in.R",
             "enviro_chem_mc_161.in.R", "enviro_chem_mc_162.in.R")


# observed data: drug in vivo Peff 
# prediction method: using jeju ration (in file: Predict drug in vivo abs (using ratio Peff_juje as denominator))
Peff_in_vivo <- read.csv("DATA/in vivo_peff_abs.csv")
colnames(Peff_in_vivo) <- c("chemical", "Peff", "Fa", "ref.")
rownames(Peff_in_vivo) <- in.file[c(1:33)]
Peff_in_vivo$abs_med_jeju.R <- NA
Peff_in_vivo$abs_LCL_jeju.R <- NA 
Peff_in_vivo$abs_UCL_jeju.R <- NA


for (i in in.file[c(1:33)]){
  
  from.path <- paste("MCsim/In files/Predict drug in vivo abs (using ratio Peff_juje as denominator)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  Peff_in_vivo[i, c(5:7)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
  write.csv(Peff_in_vivo, "outputs/Drug_Peff_in vivo_prediction_using jeju as base.csv")
  
}


# observed data: drug in vitro Papp 
# prediction method: using jeju ration (in file: Predict drug in vitro abs (using ratio Peff_juje as denominator))
Papp_in_vitro <- read.csv("DATA_abs_Peff/in vitro_papp_abs.csv")
colnames(Papp_in_vitro) <- c("chemical", "Papp", "Fa", "ref.")
rownames(Papp_in_vitro) <- in.file[c(1:70)] 
Papp_in_vitro$abs_med_jeju.R <- NA
Papp_in_vitro$abs_LCL_jeju.R <- NA 
Papp_in_vitro$abs_UCL_jeju.R <- NA


for (i in in.file[c(1:70)]){
  
  from.path <- paste("MCsim/In files/Predict drug in vitro abs (using ratio Peff_juje as denominator)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  Papp_in_vitro[i, c(5:7)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
  write.csv(Papp_in_vitro, "outputs/Drug_Papp_in vitro_prediction_all.csv")
  
}


# observed data: drug in vitro Papp 
# prediction method: using colon ration (in file: Predict drug in vitro abs (using ratio Peff_colon as denominator) - setpt)
Papp_in_vitro$abs_med_colon.R <- NA
Papp_in_vitro$abs_LCL_colon.R <- NA 
Papp_in_vitro$abs_UCL_colon.R <- NA

for (i in in.file[c(1:70)]){
  
  from.path <- paste("MCsim/In files/Predict drug in vitro abs (using ratio Peff_colon as denominator) - setpt/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  Papp_in_vitro[i, c(8:10)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
  write.csv(Papp_in_vitro, "outputs/Drug_Papp_in vitro_prediction_all.csv")

}

# observed data: drug in vitro Papp 
# prediction method: using jeju ration with IVIVE ratio (in file: Predict drug in vitro abs (using ratio Peff_juje as denominator with new IVIVE.R))
Papp_in_vitro$abs_med_jeju.R_ivive <- NA
Papp_in_vitro$abs_LCL_jeju.R_ivive <- NA 
Papp_in_vitro$abs_UCL_jeju.R_ivive <- NA

for (i in in.file[c(1:70)]){
  
  from.path <- paste("MCsim/In files/Predict drug in vitro abs (using ratio Peff_juje as denominator with new IVIVE.R)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  Papp_in_vitro[i, c(11:13)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
  write.csv(Papp_in_vitro, "outputs/Drug_Papp_in vitro_prediction_all.csv")

}


# observed data: environmental in vitro Papp 
# prediction method: using jeju ration (in file: Predict envir. chem. in vitro abs (using ratio Peff_juje as denominator))
Papp_in_vitro_envir.che <- read.csv("DATA/in vitro_papp_abs_envir.che.csv")
colnames(Papp_in_vitro_envir.che) <- c("chemical", "Papp", "Fa","unit")
rownames(Papp_in_vitro_envir.che) <- in.file[c(1:8)]
Papp_in_vitro_envir.che$abs_med_jeju.R <- NA
Papp_in_vitro_envir.che$abs_LCL_jeju.R <- NA 
Papp_in_vitro_envir.che$abs_UCL_jeju.R <- NA

for (i in in.file[c(1:8)]){
  
  from.path <- paste("MCsim/In files/Predict envir. chem. in vitro abs (using ratio Peff_juje as denominator)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  Papp_in_vitro_envir.che[i, c(5:7)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
  write.csv(Papp_in_vitro_envir.che, "outputs/Envir.che_Papp_in vitro_prediction_all.csv")
  
}

# observed data: environmental in vitro Papp 
# prediction method: using cplon ration (in file: Predict envir. chem. in vitro abs (using ratio Peff_colon as denominator) - setpt)
Papp_in_vitro_envir.che$abs_med_colon.R <- NA
Papp_in_vitro_envir.che$abs_LCL_colon.R <- NA 
Papp_in_vitro_envir.che$abs_UCL_colon.R <- NA

for (i in in.file[c(1:8)]){
  
  from.path <- paste("MCsim/In files/Predict envir. chem. in vitro abs (using ratio Peff_colon as denominator) - setpt/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  Papp_in_vitro_envir.che[i, c(8:10)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
  write.csv(Papp_in_vitro_envir.che, "outputs/Envir.che_Papp_in vitro_prediction_all.csv")

}

# observed data: environmental in vitro Papp 
# prediction method: using jeju ration with IVIVE ratio (in file: Predict envir. chem. in vitro abs (using ratio Peff_juje as denominator with new IVIVE.R))
Papp_in_vitro_envir.che$abs_med_jeju.R_ivive <- NA
Papp_in_vitro_envir.che$abs_LCL_jeju.R_ivive <- NA 
Papp_in_vitro_envir.che$abs_UCL_jeju.R_ivive <- NA

for (i in in.file[c(1:8)]){
  
  from.path <- paste("MCsim/In files/Predict envir. chem. in vitro abs (using ratio Peff_juje as denominator with new IVIVE.R)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  Papp_in_vitro_envir.che[i, c(11:13)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
  write.csv(Papp_in_vitro_envir.che, "outputs/Envir.che_Papp_in vitro_prediction_all.csv")
  
}


# observed data: drug in vitro Papp (new dataset 162 drugs) 
# prediction method: using jeju ratio with IVIVE ratio (in file: Predict drug in vitro abs (using ratio Peff_juje as denominator with new IVIVE.R)_162drugs)
Papp_in_vitro_newdata <- read.csv("DATA_abs_Peff/in vitro_papp_abs_162drugs.csv")
colnames(Papp_in_vitro_newdata) <- c("chemical", "Papp", "Fa", "ref.")
rownames(Papp_in_vitro_newdata) <- in.file
Papp_in_vitro_newdata$abs_med_jeju.R_ivive <- NA
Papp_in_vitro_newdata$abs_LCL_jeju.R_ivive <- NA 
Papp_in_vitro_newdata$abs_UCL_jeju.R_ivive <- NA

for (i in in.file){
  
  from.path <- paste("MCsim/In files/Predict drug in vitro abs (using ratio Peff_juje as denominator with new IVIVE.R)_162drugs/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  vars <- names(out)
  index <- which(vars == "C_blood_1.1" | vars == "F_bio_1.101")
  mc.sim <- apply(out[index[1]:index[2]], 2, quantile,  c(0.5, 0.025, 0.975)) %>% t()
  mc.sim <- as.data.frame(mc.sim)
  
  Papp_in_vitro_newdata[i, c(5:7)] <- mc.sim[(101*3), ] # put %abs into the "mc_sim_results"
  
  print(i)
  
  write.csv(Papp_in_vitro_newdata, "outputs/Drug_Papp_newdata162drugs_in vitro_prediction_jeju_ivive.csv")
  
}


```


```{Plotting Figure5_relationship of permeability and %abs}
# Load MC results
mc_sim_results_jeju <- read.csv("outputs/rela_p_abs_SI+LI_jeju as base.csv")
rownames(mc_sim_results_jeju) <- mc_sim_results_jeju$X
mc_sim_results_jeju <- mc_sim_results_jeju[,-1]

mc_sim_results_colon <- read.csv("outputs/rela_p_abs_SI+LI_colon as base_cov.csv")
rownames(mc_sim_results_colon) <- mc_sim_results_colon$X
mc_sim_results_colon <- mc_sim_results_colon[,-1]

mc_sim_results_jeju_ivive <- read.csv("outputs/rela_p_abs_SI+LI_newivive_jeju as base.csv")
rownames(mc_sim_results_jeju_ivive) <- mc_sim_results_jeju_ivive$X
mc_sim_results_jeju_ivive <- mc_sim_results_jeju_ivive[,-1]

# Load drug in vivo data
Peff_in_vivo <- read.csv("outputs/Drug_Peff_in vivo_prediction_using jeju as base.csv")
rownames(Peff_in_vivo) <- Peff_in_vivo$X
Peff_in_vivo <- Peff_in_vivo[,-1]

# Load drug in vitro data
Papp_in_vitro <- read.csv("outputs/Drug_Papp_in vitro_prediction_all.csv")
rownames(Papp_in_vitro) <- Papp_in_vitro$X
Papp_in_vitro <- Papp_in_vitro[,-1]

# Load environmental chemicals in vitro data
Papp_in_vitro_envir.che <- read.csv("outputs/Envir.che_Papp_in vitro_prediction_all.csv")
rownames(Papp_in_vitro_envir.che) <- Papp_in_vitro_envir.che$X
Papp_in_vitro_envir.che <- Papp_in_vitro_envir.che[,-1]


abs.diff_drug_in_vivo.1 <- Peff_in_vivo[, c(1, 3, 5, 6, 7)]
abs.diff_drug_in_vivo.1$Type <- "Drug_in_vivo"
abs.diff_drug_in_vitro.1 <- Papp_in_vitro[, c(1, 3, 5, 6, 7)]
abs.diff_drug_in_vitro.1$Type <- "Drug_in_vitro"
abs.diff_env.che_in_vitro.1 <- Papp_in_vitro_envir.che[, c(1, 3, 5, 6, 7)]
abs.diff_env.che_in_vitro.1$Type <- "Env.che_in_vitro"
abs.diff_jeju <- rbind(abs.diff_drug_in_vivo.1, abs.diff_drug_in_vitro.1, abs.diff_env.che_in_vitro.1)
abs.diff_jeju$Diff_med <- abs.diff_jeju$abs_med_jeju.R - abs.diff_jeju$Fa
abs.diff_jeju$Diff_LCL <- abs.diff_jeju$abs_LCL_jeju.R - abs.diff_jeju$Fa
abs.diff_jeju$Diff_UCL <- abs.diff_jeju$abs_UCL_jeju.R - abs.diff_jeju$Fa

abs.diff_drug_in_vitro.2 <- Papp_in_vitro[, c(1, 3, 8, 9, 10)]
abs.diff_drug_in_vitro.2$Type <- "Drug_in_vitro"
abs.diff_env.che_in_vitro.2 <- Papp_in_vitro_envir.che[, c(1, 3, 8, 9, 10)]
abs.diff_env.che_in_vitro.2$Type <- "Env.che_in_vitro"
abs.diff_colon <- rbind(abs.diff_drug_in_vitro.2, abs.diff_env.che_in_vitro.2)
abs.diff_colon$Diff_med <- abs.diff_colon$abs_med_colon.R - abs.diff_colon$Fa
abs.diff_colon$Diff_LCL <- abs.diff_colon$abs_LCL_colon.R - abs.diff_colon$Fa
abs.diff_colon$Diff_UCL <- abs.diff_colon$abs_UCL_colon.R - abs.diff_colon$Fa

abs.diff_drug_in_vitro.3 <- Papp_in_vitro[, c(1, 3, 11, 12, 13)]
abs.diff_drug_in_vitro.3$Type <- "Drug_in_vitro"
abs.diff_env.che_in_vitro.3 <- Papp_in_vitro_envir.che[, c(1, 3, 11, 12, 13)]
abs.diff_env.che_in_vitro.3$Type <- "Env.che_in_vitro"
abs.diff_jeju_ivive <- rbind(abs.diff_drug_in_vitro.3, abs.diff_env.che_in_vitro.3)
abs.diff_jeju_ivive$Diff_med <- abs.diff_jeju_ivive$abs_med_jeju.R_ivive - abs.diff_jeju_ivive$Fa
abs.diff_jeju_ivive$Diff_LCL <- abs.diff_jeju_ivive$abs_LCL_jeju.R_ivive - abs.diff_jeju_ivive$Fa
abs.diff_jeju_ivive$Diff_UCL <- abs.diff_jeju_ivive$abs_UCL_jeju.R_ivive - abs.diff_jeju_ivive$Fa

p5.1 <- ggplot() + 
  geom_line(aes(x=mc_sim_results_jeju$Peff_cm_s, y=mc_sim_results_jeju$abs_med), linetype = "solid", color="#26A7FF", size = 1.1) + 
  geom_ribbon(aes(x=mc_sim_results_jeju$Peff_cm_s, ymin = mc_sim_results_jeju$abs_LCL, ymax = mc_sim_results_jeju$abs_UCL), fill = "#26A7FF20") +
  
  geom_point(aes(x=Peff_in_vivo$Peff, y=Peff_in_vivo$Fa), color="#4C65FF99", size=1.8, shape=16)+
  geom_point(aes(x=Papp_in_vitro$Papp, y=Papp_in_vitro$Fa), color="#FD490299", size=1.8, shape=16) +
  geom_point(aes(x=Papp_in_vitro_envir.che$Papp, y=Papp_in_vitro_envir.che$Fa), color="#009513", size=2.2, shape=24, fill = "#00951350") +
  
  
  scale_x_log10(lim = c(1E-8,1E-2),
                breaks = trans_breaks("log10", function(x) 10^x, n = 6),
                labels = trans_format("log10", math_format(10^.x))) +
  
  annotate("point", x=1.5e-4, y=40, color="#4C65FF99", size=2, shape=16) +
  annotate("text", x=1.9e-4, y=40, label=expression(paste("Drug in vivo ", "P"[eff])), hjust=0, size = 2.8) +
  
  annotate("point", x=1.5e-4, y=30, color="#FD490299", size=2, shape=16) +
  annotate("text", x=1.9e-4, y=30, label=expression(paste("Drug in vitro ", "P"[app])), hjust=0, size = 2.8) +
  
  annotate("point", x=1.5e-4, y=20, color="#009513", size=2, shape=24, fill = "#00951350") +
  annotate("text", x=1.9e-4, y=20, label=expression(paste("Environmental chemical in vitro ", "P"[app])), hjust=0, size = 2.8) +
  
  annotate("text", x=1e-8, y=98, label="A", hjust=0, fontface = "bold", size=5) +
  
  xlab(expression(paste("P"[eff], " or P"[app], " = Jejunum permeability (cm/s)"))) + ylab("Percentage of absorption")+
  
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black"),
        axis.text = element_text(color = "black"))

p5.2 <-  ggplot() + 
  geom_line(aes(x=mc_sim_results_colon$Peff_cm_s, y=mc_sim_results_colon$abs_med), linetype = "solid", color="#6EC388", size = 1.1) + 
  geom_ribbon(aes(x=mc_sim_results_colon$Peff_cm_s, ymin = mc_sim_results_colon$abs_LCL, ymax = mc_sim_results_colon$abs_UCL), fill = "#6EC38820") +
  
  geom_point(aes(x=Papp_in_vitro$Papp, y=Papp_in_vitro$Fa), color="#FD490299", size=1.8, shape=16) +
  geom_point(aes(x=Papp_in_vitro_envir.che$Papp, y=Papp_in_vitro_envir.che$Fa), color="#009513", size=2.2, shape=24, fill = "#00951350") +
  
  scale_x_log10(lim = c(1E-8,1E-2),
                breaks = trans_breaks("log10", function(x) 10^x, n = 6),
                labels = trans_format("log10", math_format(10^.x))) +
  
  #annotate("point", x=1.5e-4, y=30, color="#FD490299", size=2, shape=16) +
  #annotate("text", x=1.9e-4, y=30, label=expression(paste("Drug in vitro ", "P"[app])), hjust=0, size = 2.8) +
  
  #annotate("point", x=1.5e-4, y=20, color="#009513", size=2, shape=24, fill = "#00951350") +
  #annotate("text", x=1.9e-4, y=20, label=expression(paste("Environmental chemical in vitro ", "P"[app])), hjust=0, size = 2.8) +
  
  
  annotate("text", x=1e-8, y=98, label="B", hjust=0, fontface = "bold", size=5) +
  
  xlab(expression(paste("P"[app], " = Colon permeability (cm/s)"))) + ylab("Percentage of absorption")+
  
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black"),
        axis.text = element_text(color = "black"))

p5.3 <- ggplot() + 
  geom_line(aes(x=mc_sim_results_jeju_ivive$Peff_cm_s, y=mc_sim_results_jeju_ivive$abs_med), linetype = "solid", color="#FFB455", size = 1.1) + 
  geom_ribbon(aes(x=mc_sim_results_jeju_ivive$Peff_cm_s, ymin = mc_sim_results_jeju_ivive$abs_LCL, ymax = mc_sim_results_jeju_ivive$abs_UCL), fill = "#FFB45520") +
  
  geom_point(aes(x=Papp_in_vitro$Papp, y=Papp_in_vitro$Fa), color="#FD490299", size=1.8, shape=16) +
  geom_point(aes(x=Papp_in_vitro_envir.che$Papp, y=Papp_in_vitro_envir.che$Fa), color="#009513", size=2.2, shape=24, fill = "#00951350") +
  
  scale_x_log10(lim = c(1E-8,1E-2),
                breaks = trans_breaks("log10", function(x) 10^x, n = 6),
                labels = trans_format("log10", math_format(10^.x))) +
  
  #annotate("point", x=1.5e-4, y=30, color="#FD490299", size=2, shape=16) +
  #annotate("text", x=1.9e-4, y=30, label=expression(paste("Drug in vitro ", "P"[app])), hjust=0, size = 2.8) +
  
  #annotate("point", x=1.5e-4, y=20, color="#009513", size=2, shape=24, fill = "#00951350") +
  #annotate("text", x=1.9e-4, y=20, label=expression(paste("Environmental chemical in vitro ", "P"[app])), hjust=0, size = 2.8) +
  
  
  annotate("text", x=1e-8, y=98, label="C", hjust=0, fontface = "bold", size=5) +
  
  xlab(expression(paste("P"[app], symbol('\256'), "P"[eff],  " = Jejunum permeability (cm/s)"))) + ylab("Percentage of absorption")+
  
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black"),
        axis.text = element_text(color = "black"))


abs.diff_jeju$chemical = with(abs.diff_jeju, reorder(chemical, Diff_med))
p5.4 <- ggplot(abs.diff_jeju, aes(x= chemical, y = Diff_med, group = Type)) +
  geom_segment(aes(x=chemical, xend=chemical, y=Diff_LCL, yend=Diff_UCL, color=Type), size=0.25) +
  geom_point(aes(color = Type, shape = Type, fill = Type), size=0.6) +
  scale_shape_manual(values = c(21, 21, 24)) +
  scale_color_manual(values = c("#FE7741", "#798CFF", "#009513"))+
  scale_fill_manual(values = c("#FE7741", "#798CFF", "#9FD7A7")) +
  annotate("text", x=74, y=-95, label="D", hjust=0, fontface = "bold", size=5) +
  scale_y_continuous(breaks=c(-100, -50, -20, 0, 20, 50, 100))+
  theme_light() +
  coord_flip() +
  ylab(expression(paste(Delta, "F"[abs]))) + xlab("")+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        legend.position="none",
        axis.ticks.x = element_line(color = "black", size = 0.5),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(color = "black", face = "bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(color = "black", vjust = -0.3),
        axis.text.y = element_blank())

abs.diff_colon$chemical = with(abs.diff_colon, reorder(chemical, Diff_med))
p5.5 <- ggplot(abs.diff_colon, aes(x= chemical, y = Diff_med, group = Type)) +
  geom_segment(aes(x=chemical, xend=chemical, y=Diff_LCL, yend=Diff_UCL, color=Type), size=0.25) +
  geom_point(aes(color = Type, shape = Type, fill = Type), size=0.6) +
  scale_shape_manual(values = c(21, 24)) +
  scale_color_manual(values = c("#FE7741", "#009513"))+
  scale_fill_manual(values = c("#FE7741", "#9FD7A7")) +
  annotate("text", x=55.8, y=-95, label="E", hjust=0, fontface = "bold", size=5) +
  scale_y_continuous(breaks=c(-100, -50, -20, 0, 20, 50, 100))+
  theme_light() +
  coord_flip() +
  ylab(expression(paste(Delta, "F"[abs]))) + xlab("")+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        legend.position="none",
        axis.ticks.x = element_line(color = "black", size = 0.5),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(color = "black", face = "bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(color = "black", vjust = -0.3),
        axis.text.y = element_blank())

abs.diff_jeju_ivive$chemical = with(abs.diff_jeju_ivive, reorder(chemical, Diff_med))
p5.6 <- ggplot(abs.diff_jeju_ivive, aes(x= chemical, y = Diff_med, group = Type)) +
  geom_segment(aes(x=chemical, xend=chemical, y=Diff_LCL, yend=Diff_UCL, color=Type), size=0.25) +
  geom_point(aes(color = Type, shape = Type, fill = Type), size=0.6) +
  scale_shape_manual(values = c(21, 24)) +
  scale_color_manual(values = c("#FE7741", "#009513"))+
  scale_fill_manual(values = c("#FE7741", "#9FD7A7")) +
  annotate("text", x=55.8, y=-95, label="F", hjust=0, fontface = "bold", size=5) +
  scale_y_continuous(breaks=c(-100, -50, -20, 0, 20, 50, 100))+
  theme_light() +
  coord_flip() +
  ylab(expression(paste(Delta, "F"[abs]))) + xlab("")+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        legend.position="none",
        axis.ticks.x = element_line(color = "black", size = 0.5),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(color = "black", face = "bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(color = "black", vjust = -0.3),
        axis.text.y = element_blank())

tiff(width = 12.2, height = 12.5, "plots/Figure.5_relationship of permeability and abs.tiff", units = "in", res=600)
p5.1 + p5.4 + p5.2 + p5.5 + p5.3 + p5.6 + plot_layout(widths = c(1.2/2, 0.8/2), height = c(4, 4, 4))
dev.off()

# writing information in the "Results" part of paper
Peff_in_vivo$abs_LCL_jeju.R <- round(Peff_in_vivo$abs_LCL_jeju.R)
Peff_in_vivo$abs_UCL_jeju.R <- round(Peff_in_vivo$abs_UCL_jeju.R)
Peff_in_vivo$within_95CI[Peff_in_vivo$Fa >= Peff_in_vivo$abs_LCL_jeju.R & Peff_in_vivo$Fa <= Peff_in_vivo$abs_UCL_jeju.R] <- 1
sum(Peff_in_vivo$within_95CI, na.rm = T)

Papp_in_vitro[, c(6,7,9,10,12,13)] <- round(Papp_in_vitro[, c(6,7,9,10,12,13)])
Papp_in_vitro$within_95CI_jeju[Papp_in_vitro$Fa >= Papp_in_vitro$abs_LCL_jeju.R & Papp_in_vitro$Fa <=  Papp_in_vitro$abs_UCL_jeju.R] <- 1
Papp_in_vitro$within_95CI_colon[Papp_in_vitro$Fa >= Papp_in_vitro$abs_LCL_colon.R & Papp_in_vitro$Fa <=  Papp_in_vitro$abs_UCL_colon.R] <- 1
Papp_in_vitro$within_95CI_jeju_ivive[Papp_in_vitro$Fa >= Papp_in_vitro$abs_LCL_jeju.R_ivive & Papp_in_vitro$Fa <=  Papp_in_vitro$abs_UCL_jeju.R_ivive] <- 1
sum(Papp_in_vitro$within_95CI_jeju, na.rm = T)
sum(Papp_in_vitro$within_95CI_colon, na.rm = T)
sum(Papp_in_vitro$within_95CI_jeju_ivive, na.rm = T)

Papp_in_vitro_envir.che[, c(6,7,9,10,12,13)] <- round(Papp_in_vitro_envir.che[, c(6,7,9,10,12,13)])
Papp_in_vitro_envir.che$within_95CI_jeju[Papp_in_vitro_envir.che$Fa >= Papp_in_vitro_envir.che$abs_LCL_jeju.R & Papp_in_vitro_envir.che$Fa <=  Papp_in_vitro_envir.che$abs_UCL_jeju.R] <- 1
Papp_in_vitro_envir.che$within_95CI_colon[Papp_in_vitro_envir.che$Fa >= Papp_in_vitro_envir.che$abs_LCL_colon.R & Papp_in_vitro_envir.che$Fa <=  Papp_in_vitro_envir.che$abs_UCL_colon.R] <- 1
Papp_in_vitro_envir.che$within_95CI_jeju_ivive[Papp_in_vitro_envir.che$Fa >= Papp_in_vitro_envir.che$abs_LCL_jeju.R_ivive & Papp_in_vitro_envir.che$Fa <=  Papp_in_vitro_envir.che$abs_UCL_jeju.R_ivive] <- 1
sum(Papp_in_vitro_envir.che$within_95CI_jeju, na.rm = T)
sum(Papp_in_vitro_envir.che$within_95CI_colon, na.rm = T)
sum(Papp_in_vitro_envir.che$within_95CI_jeju_ivive, na.rm = T)

Papp_in_vitro_newdata[, c(6,7)] <- round(Papp_in_vitro_newdata[, c(6,7)])
Papp_in_vitro_newdata$within_95CI_jeju_ivive[Papp_in_vitro_newdata$Fa >= Papp_in_vitro_newdata$abs_LCL_jeju.R_ivive & Papp_in_vitro_newdata$Fa <=  Papp_in_vitro_newdata$abs_UCL_jeju.R_ivive] <- 1
sum(Papp_in_vitro_newdata$within_95CI_jeju_ivive, na.rm = T)

```


```{Plotting FigureS3_relationship of permeability and %abs with new data (162 drugs)}
Papp_in_vitro_newdata <- read.csv("outputs/Drug_Papp_newdata162drugs_in vitro_prediction_jeju_ivive.csv")
rownames(Papp_in_vitro_newdata) <- Papp_in_vitro_newdata$X
Papp_in_vitro_newdata <- Papp_in_vitro_newdata[,-1]

abs.diff_drug_in_vitro.4 <- Papp_in_vitro_newdata[, c(1, 3, 5, 6, 7)]
abs.diff_drug_in_vitro.4$Type <- "Drug_in_vitro"
abs.diff_jeju_ivive_newdata <- abs.diff_drug_in_vitro.4
abs.diff_jeju_ivive_newdata$Diff_med <- abs.diff_jeju_ivive_newdata$abs_med_jeju.R_ivive - abs.diff_jeju_ivive_newdata$Fa
abs.diff_jeju_ivive_newdata$Diff_LCL <- abs.diff_jeju_ivive_newdata$abs_LCL_jeju.R_ivive - abs.diff_jeju_ivive_newdata$Fa
abs.diff_jeju_ivive_newdata$Diff_UCL <- abs.diff_jeju_ivive_newdata$abs_UCL_jeju.R_ivive - abs.diff_jeju_ivive_newdata$Fa

ps3.1 <- ggplot() + 
  geom_line(aes(x=mc_sim_results_jeju_ivive$Peff_cm_s, y=mc_sim_results_jeju_ivive$abs_med), linetype = "solid", color="#FFB455", size = 1.1) + 
  geom_ribbon(aes(x=mc_sim_results_jeju_ivive$Peff_cm_s, ymin = mc_sim_results_jeju_ivive$abs_LCL, ymax = mc_sim_results_jeju_ivive$abs_UCL), fill = "#FFB45520") +
  
  geom_point(aes(x=Papp_in_vitro_newdata$Papp, y=Papp_in_vitro_newdata$Fa), color="#FD490299", size=1.8, shape=16) +

  scale_x_log10(lim = c(1E-8,1E-2),
                breaks = trans_breaks("log10", function(x) 10^x, n = 6),
                labels = trans_format("log10", math_format(10^.x))) +
  
  annotate("point", x=1.5e-4, y=30, color="#FD490299", size=2, shape=16) +
  annotate("text", x=1.9e-4, y=30, label=expression(paste("Drug in vitro ", "P"[app])), hjust=0, size = 2.8) +
  
  annotate("text", x=1e-8, y=98, label="A", hjust=0, fontface = "bold", size=5) +
  
  xlab(expression(paste("P"[app], symbol('\256'), "P"[eff],  " = Jejunum permeability (cm/s)"))) + ylab("Percentage of absorption")+
  
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black"),
        axis.text = element_text(color = "black"))

abs.diff_jeju_ivive_newdata$chemical = with(abs.diff_jeju_ivive_newdata, reorder(chemical, Diff_med))
ps3.2 <- ggplot(abs.diff_jeju_ivive_newdata, aes(x= chemical, y = Diff_med, group = Type)) +
  geom_segment(aes(x=chemical, xend=chemical, y=Diff_LCL, yend=Diff_UCL, color=Type), size=0.25) +
  geom_point(aes(color = Type, shape = Type, fill = Type), size=0.6) +
  scale_shape_manual(values = c(21)) +
  scale_color_manual(values = c("#FE7741"))+
  scale_fill_manual(values = c("#FE7741")) +
  annotate("text", x=105, y=-95, label="B", hjust=0, fontface = "bold", size=5) +
  scale_y_continuous(breaks=c(-100, -50, -20, 0, 20, 50, 100))+
  theme_light() +
  coord_flip() +
  ylab(expression(paste(Delta, "F"[abs]))) + xlab("")+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
        panel.grid.minor = element_blank(),
        legend.position="none",
        axis.ticks.x = element_line(color = "black", size = 0.5),
        axis.ticks.y = element_blank(),
        axis.title.x = element_text(color = "black", face = "bold"),
        axis.title.y = element_blank(),
        axis.text.x = element_text(color = "black", vjust = -0.3),
        axis.text.y = element_blank())


tiff(width = 12.2, height = 5.5, "plots/Figure.S3_relationship of permeability and abs_newdrugdata.tiff", units = "in", res=600)
ps3.1 + ps3.2 + plot_layout(widths = c(1.2/2, 0.8/2))
dev.off()
```


```{Prediction of Fabs for Environmental Chemicals and Plotting Figure6_pedicted Fabs of environmental chemicals_with 95CI}
# ---------- Prediction of Fabs for HTTK Chemicals ----------
HTTK_abs_ivive_jeju <- as.data.frame(matrix(NA, 20, 10001))
rownames(HTTK_abs_ivive_jeju) <- in.file[c(1:20)]
HTTK.Chem.list <- read.csv("DATA/Env.Chem.list.csv")
colnames(HTTK_abs_ivive_jeju)[1] <- "Chemical"
HTTK_abs_ivive_jeju$Chemical <- HTTK.Chem.list$Compound
HTTK_Css_ivive_jeju <- HTTK_abs_ivive_jeju


# used jeju ratio and ivivc ratio
for (i in in.file[c(1:20)]){
  
  from.path <- paste("MCsim/In files/Predict HTTK envir. chem. abs (using ratio Peff_juje as denominator with new IVIVE.R)/", i, sep = "")
  file.copy(from.path, "MCsim", overwrite = T)
  
  out <- mcsim(model, i)
  
  HTTK_abs_ivive_jeju[i, c(2:10001)] <- out$F_bio_1.101
  HTTK_Css_ivive_jeju[i, c(2:10001)] <- out$C_ss_equ_1.101 
  
  print(i)
  write.csv(HTTK_abs_ivive_jeju, "outputs/Envir.che_HTTK_abs_prediction_ivive_jeju.csv")
  write.csv(HTTK_Css_ivive_jeju, "outputs/Envir.che_HTTK_Css_prediction_ivive_jeju.csv")
}




# ---------- Plotting: Figure.6_pedicted Fabs of environmental chemicals_with 95CI ----------
HTTK_abs_ivive_jeju <- read.csv("outputs/Envir.che_HTTK_abs_prediction_ivive_jeju.csv")
HTTK_abs_ivive_jeju <- HTTK_abs_ivive_jeju[, -1]
rownames(HTTK_abs_ivive_jeju) <- HTTK_abs_ivive_jeju$Chemical
HTTK_abs_ivive_jeju_plot <- HTTK_abs_ivive_jeju[, -1]


HTTK_abs_ivive_jeju_boxplot <- stack(as.data.frame(t(HTTK_abs_ivive_jeju_plot)))
colnames(HTTK_abs_ivive_jeju_boxplot) <- c("Fabs", "Chemical")

quantiles_95 <- function(x){
  r <- quantile(x, probs=c(0.025, 0.25, 0.5, 0.75, 0.975), na.rm = T)
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  r
}

Fabs_for_calODE <- data.frame(Chemical = HTTK_abs_ivive_jeju$Chemical, Fabs_2.5thtile = NA, Fabs_25thtile = NA, 
                              Fabs_median = NA, Fabs_75thtile = NA, Fabs_97.5thtile = NA)
for (i in 1:20){
  Fabs_for_calODE[i, c(2:6)] <- quantile(HTTK_abs_ivive_jeju[i, c(2:10001)], probs=c(0.025, 0.25, 0.5, 0.75, 0.975), na.rm = T)
}
write.csv(Fabs_for_calODE, "outputs/Figure 6 data.csv")
Fabs_for_calODE$Fabs_2.5thtile <- Fabs_for_calODE$Fabs_2.5thtile / 100
Fabs_for_calODE$Fabs_97.5thtile <- Fabs_for_calODE$Fabs_97.5thtile / 100

# Load obs. data
Fabs_obs <- data.frame(chemical = HTTK_abs_ivive_jeju$Chemical,
                       Fabs = NA)
obs.list <- Papp_in_vitro_envir.che$chemical
for(i in c(1:8)){
  Fabs_obs$Fabs[Fabs_obs$chemical == Papp_in_vitro_envir.che$chemical[i]] <- Papp_in_vitro_envir.che$Fa[i]
  
}

HTTK_abs_ivive_jeju_boxplot$median <- rep(Fabs_for_calODE$Fabs_median, each = 10000)
tiff(width = 6.5, height = 4.8, "plots/Figure.6_Pedicted Fabs of environmental chemicals_with 95CI.tiff", units = "in", res=600)
ggplot(HTTK_abs_ivive_jeju_boxplot, aes(x=reorder(Chemical, median), y=Fabs)) + 
  coord_flip() +
  stat_summary(fun.data = quantiles_95, geom="boxplot", width=0.5, fill = "#DCDFFC", color = "#4553EA")+
  geom_point(data = Fabs_obs, aes(x=chemical, y=Fabs), color="#EB1919", size=2.3, shape=21, fill = "#EB191995") +
  xlab("Chemical") + ylab(expression(paste("F"[abs])))+
  ylim(c(0, 100)) + 
  theme_bw()+
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major.x= element_blank(),
        panel.grid.major.y = element_line(color = "gray", linetype = "dotted"),
        panel.grid.minor = element_blank(),
        legend.position = "none",
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black"),
        axis.text = element_text(color = "black"))
dev.off()

```


```{Risk prioritization and Plotting Figure7_OED compare with exposure}
# load data
risk_prior_data <- read.csv("DATA/risk_prior_data.csv")
risk_prior_data$CAS <- as.character(risk_prior_data$CAS)
risk_prior_data$Css_95tile_3comss <- NA
risk_prior_data$Css_95tile_pbtk <- NA
risk_prior_data$Css_95tile_pbtk_Fabs_95up <- NA
risk_prior_data$Css_95tile_pbtk_Fabs_95dn <- NA
risk_prior_data$Css_95tile_pbtk_Fabs_obs <- NA
# change Funbound.plasma of Novaluron = 0.005
chem.physical_and_invitro.data <- chem.physical_and_invitro.data
chem.physical_and_invitro.data$Human.Funbound.plasma[chem.physical_and_invitro.data$CAS == "116714-46-6"] <- 0.005

# Calculate Css with predicted Fabs
for(i in c(1:16,18:20)){
  
  risk_prior_data$Css_95tile_3comss[i] <- calc_mc_css(chem.cas = risk_prior_data$CAS[i], model = "3compartmentss",  samples = 10000, 
                                                      invitro.mc.arg.list = list(adjusted.Funbound.plasma = TRUE, poormetab = TRUE, 
                                                                                 fup.censored.dist = FALSE, fup.lod = 0.01, fup.meas.cv = 0.3, 
                                                                                 clint.meas.cv = 0.3, fup.pop.cv = 0.3, clint.pop.cv = 0.3))
  
  risk_prior_data$Css_95tile_pbtk[i] <- calc_mc_css(chem.cas = risk_prior_data$CAS[i], model = "pbtk",  samples = 10000, 
                                                    invitro.mc.arg.list = list(adjusted.Funbound.plasma = TRUE, poormetab = TRUE, 
                                                                               fup.censored.dist = FALSE, fup.lod = 0.01, fup.meas.cv = 0.3, 
                                                                               clint.meas.cv = 0.3, fup.pop.cv = 0.3, clint.pop.cv = 0.3))
  risk_prior_data$Css_95tile_pbtk_Fabs_95up[i] <- risk_prior_data$Css_95tile_pbtk[i] * Fabs_for_calODE$Fabs_97.5thtile[Fabs_for_calODE$Chemical == risk_prior_data$Chemical[i]]
  risk_prior_data$Css_95tile_pbtk_Fabs_95dn[i] <- risk_prior_data$Css_95tile_pbtk[i] * Fabs_for_calODE$Fabs_2.5thtile[Fabs_for_calODE$Chemical == risk_prior_data$Chemical[i]]

}

# Calculate Css with observed Fabs
obs.list <- Papp_in_vitro_envir.che$chemical
for(i in c(1:8)){
  risk_prior_data$Css_95tile_pbtk_Fabs_obs[risk_prior_data$Chemical == obs.list[i]] <- 
    risk_prior_data$Css_95tile_pbtk[risk_prior_data$Chemical == obs.list[i]] * Papp_in_vitro_envir.che$Fa[Papp_in_vitro_envir.che$chemical == obs.list[i]]/100

}

# Calculate Css of Ochratoxin A (clearance = 0.0905 ml/h/kg)
risk_prior_data$Css_95tile_3comss[risk_prior_data$Chemical == "Ochratoxin A"] <-1 / (0.0905*24/1000) # mg/L 
risk_prior_data$Css_95tile_pbtk[risk_prior_data$Chemical == "Ochratoxin A"] <- risk_prior_data$Css_95tile_3comss[risk_prior_data$Chemical == "Ochratoxin A"]
risk_prior_data$Css_95tile_pbtk_Fabs_95up[risk_prior_data$Chemical == "Ochratoxin A"] <- risk_prior_data$Css_95tile_pbtk[risk_prior_data$Chemical == "Ochratoxin A"] * Fabs_for_calODE$Fabs_97.5thtile[Fabs_for_calODE$Chemical == "Ochratoxin A"]
risk_prior_data$Css_95tile_pbtk_Fabs_95dn[risk_prior_data$Chemical == "Ochratoxin A"] <- risk_prior_data$Css_95tile_pbtk[risk_prior_data$Chemical == "Ochratoxin A"] * Fabs_for_calODE$Fabs_2.5thtile[Fabs_for_calODE$Chemical == "Ochratoxin A"]
risk_prior_data$Css_95tile_pbtk_Fabs_obs[risk_prior_data$Chemical == "Ochratoxin A"] <- risk_prior_data$Css_95tile_pbtk[risk_prior_data$Chemical == "Ochratoxin A"] * Papp_in_vitro_envir.che$Fa[Papp_in_vitro_envir.che$chemical == "Ochratoxin A"]/100

# Calculate OED by using different Css
risk_prior_data$OED_5tile_3comss  <- risk_prior_data$AC50_5._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_3comss
risk_prior_data$OED_25tile_3comss <- risk_prior_data$AC50_25._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_3comss
risk_prior_data$OED_50tile_3comss <- risk_prior_data$AC50_50._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_3comss
risk_prior_data$OED_75tile_3comss <- risk_prior_data$AC50_75._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_3comss
risk_prior_data$OED_95tile_3comss <- risk_prior_data$AC50_95._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_3comss

risk_prior_data$OED_5tile_fabs_obs  <- risk_prior_data$AC50_5._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_obs
risk_prior_data$OED_25tile_fabs_obs <- risk_prior_data$AC50_25._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_obs
risk_prior_data$OED_50tile_fabs_obs <- risk_prior_data$AC50_50._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_obs
risk_prior_data$OED_75tile_fabs_obs <- risk_prior_data$AC50_75._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_obs
risk_prior_data$OED_95tile_fabs_obs <- risk_prior_data$AC50_95._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_obs

risk_prior_data$OED_5tile_fabs_95up  <- risk_prior_data$AC50_5._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95up
risk_prior_data$OED_25tile_fabs_95up <- risk_prior_data$AC50_25._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95up
risk_prior_data$OED_50tile_fabs_95up <- risk_prior_data$AC50_50._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95up
risk_prior_data$OED_75tile_fabs_95up <- risk_prior_data$AC50_75._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95up
risk_prior_data$OED_95tile_fabs_95up <- risk_prior_data$AC50_95._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95up

risk_prior_data$OED_5tile_fabs_95dn  <- risk_prior_data$AC50_5._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95dn
risk_prior_data$OED_25tile_fabs_95dn <- risk_prior_data$AC50_25._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95dn
risk_prior_data$OED_50tile_fabs_95dn <- risk_prior_data$AC50_50._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95dn
risk_prior_data$OED_75tile_fabs_95dn <- risk_prior_data$AC50_75._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95dn
risk_prior_data$OED_95tile_fabs_95dn <- risk_prior_data$AC50_95._percentile * 0.001 * risk_prior_data$MW / risk_prior_data$Css_95tile_pbtk_Fabs_95dn

write.csv(risk_prior_data, "outputs/Figure 7 data.csv")


# ---------- Plotting: Figure.7_OED compare with exposure ----------
boxplot_temp_data <- risk_prior_data[, c("Chemical", 
                                         "OED_5tile_3comss", "OED_25tile_3comss", "OED_50tile_3comss", "OED_75tile_3comss", "OED_95tile_3comss",
                                         "OED_5tile_fabs_obs", "OED_25tile_fabs_obs", "OED_50tile_fabs_obs", "OED_75tile_fabs_obs", "OED_95tile_fabs_obs",
                                         "OED_5tile_fabs_95up", "OED_25tile_fabs_95up", "OED_50tile_fabs_95up", "OED_75tile_fabs_95up", "OED_95tile_fabs_95up",
                                         "OED_5tile_fabs_95dn", "OED_25tile_fabs_95dn", "OED_50tile_fabs_95dn", "OED_75tile_fabs_95dn", "OED_95tile_fabs_95dn")]
boxplot_risk_prior_data <- as.data.frame(matrix(NA, 400, 4))
colnames(boxplot_risk_prior_data) <- c("Chemical", "value", "percentile", "lable")
boxplot_risk_prior_data$Chemical <- rep(risk_prior_data$Chemical, 20)
boxplot_risk_prior_data$value <- stack(boxplot_temp_data[, c(2:21)])$values
boxplot_risk_prior_data$percentile <- stack(boxplot_temp_data[, c(2:21)])$ind
boxplot_risk_prior_data$lable <- rep(c("HTTK model", "ECAT model w/ observed Fabs", "ECAT model w/ 97.5th percentile of Fabs", "ECAT model w/ 2.5th percentile of Fabs"), each = 100)

quantiles <- function(x) {
  r <- sort(x)
  names(r) <- c("ymin", "lower", "middle", "upper", "ymax")
  r
}

risk_prior_data$order <- risk_prior_data$OED_50tile_3comss 
boxplot_risk_prior_data$order <- rep(risk_prior_data$order, 20)

boxplot_risk_prior_data$lable <- factor(boxplot_risk_prior_data$lable, levels = c("HTTK model", "ECAT model w/ 97.5th percentile of Fabs", "ECAT model w/ 2.5th percentile of Fabs", "ECAT model w/ observed Fabs"))


tiff(width = 12, height = 6, "plots/Figure.7_OED compare with exposure.tiff", units = "in", res=600)
ggplot(boxplot_risk_prior_data, aes(x=reorder(Chemical, order), y=value, color = lable)) + 
  stat_summary(fun.data = quantiles, geom="boxplot", width=0.45, size = 0.72, position = position_dodge2(width = 1, padding = 0.4, preserve = "single"))+
  
  geom_point(data = risk_prior_data, aes(x = Chemical, y = Exposure_Total.median), color = "#A80C0C", size = 2)+
  geom_segment(data = risk_prior_data, aes(x = Chemical, y = Exposure_Total.median, xend = Chemical, yend = Exposure_Total.95..ile), color = "#F0545440", size = 2.5)+
  
  scale_y_log10(lim = c(1E-10,1E+4),
                breaks = trans_breaks("log10", function(x) 10^x, n = 6),
                labels = trans_format("log10", math_format(10^.x))) +
  scale_color_manual(values = c("#0F4EB1", "#0FB147", "#A5E2BA", "#EB8D10"))+
  xlab("Chemical") + ylab("Oral equivalent dose or Inferred exposure (mg/kg/day)") +
  theme_bw() +
  theme(panel.border = element_rect(colour = "black", size = 1.05),
        panel.grid.major.x= element_blank(),
        panel.grid.major.y = element_line(color = "gray", linetype = "dotted"),
        panel.grid.minor = element_blank(),
        legend.position = c(0.15, 0.85),
        legend.title = element_blank(),
        legend.background = element_rect(fill="#00000000"),
        axis.ticks = element_line(color = "black"),
        axis.title = element_text(color = "black"),
        axis.text.y = element_text(color = "black"),
        axis.text.x = element_text(color = "black", angle = 45, hjust = 1))
dev.off()
```

